<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Offline → Gmail Queue</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeOutUp {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-10px); height: 0; padding: 0; margin: 0; border: 0; }
    }
    @keyframes pulse-green {
      0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
    }
    @keyframes pulse-red {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
    }
    .item-enter {
      animation: fadeInDown 0.5s ease-out forwards;
    }
    .item-exit {
      animation: fadeOutUp 0.5s ease-in forwards;
    }
    .status-indicator.online {
      background-color: #22c55e; /* green-500 */
      animation: pulse-green 2s infinite;
    }
    .status-indicator.offline {
      background-color: #ef4444; /* red-500 */
      animation: pulse-red 2s infinite;
    }
    #toast-container {
      position: fixed;
      top: 1.5rem;
      right: 1.5rem;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .toast {
      display: flex;
      align-items: center;
      padding: 1rem;
      border-radius: 0.5rem;
      color: white;
      font-weight: 600;
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      animation: fadeInDown 0.3s ease-out;
      opacity: 0;
      transform: translateY(-10px);
    }
    .toast.success { background-color: #22c55e; } /* green-500 */
    .toast.error { background-color: #ef4444; }   /* red-500 */
    .toast.info { background-color: #3b82f6; }    /* blue-500 */
  </style>
</head>
<body class="bg-gray-900 text-gray-300 font-sans">

  <div id="toast-container"></div>

  <div class="max-w-4xl mx-auto p-4 sm:p-6">
    <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pb-6 border-b border-gray-700">
      <h1 class="text-3xl font-bold text-white">Offline Gmail Queue</h1>
      <div class="flex items-center gap-4">
        <div class="flex items-center gap-2">
          <div id="onlineStatus" class="status-indicator w-3 h-3 rounded-full"></div>
          <span id="onlineStatusText" class="font-semibold capitalize">Offline</span>
        </div>
        <button id="authBtn" class="flex items-center gap-2 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>
          Sign In
        </button>
      </div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-6">
      <!-- Compose Section -->
      <section>
        <h2 class="text-xl font-semibold text-white mb-4">Compose Email</h2>
        <div class="flex flex-col gap-4">
          <div>
            <label for="toInput" class="block text-sm font-medium mb-1">To (comma-separated)</label>
            <input id="toInput" placeholder="alice@example.com" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
          </div>
          <div>
            <label for="subjectInput" class="block text-sm font-medium mb-1">Subject</label>
            <input id="subjectInput" placeholder="Your subject line" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
          </div>
          <div>
            <label for="bodyInput" class="block text-sm font-medium mb-1">Message</label>
            <textarea id="bodyInput" placeholder="Write your message here..." rows="6" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"></textarea>
          </div>
          <div class="flex flex-wrap gap-3">
            <button id="saveBtn" class="flex-1 flex items-center justify-center gap-2 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
              Save to Queue
            </button>
            <button id="sendNowBtn" class="flex-1 flex items-center justify-center gap-2 bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
              Send Now
            </button>
          </div>
        </div>
      </section>

      <!-- Queue & Log Section -->
      <section>
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold text-white">Queue</h2>
          <button id="sendQueueBtn" class="flex items-center gap-2 bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2.2 2.2 12 12l9.8 9.8"/><path d="m21.8 2.2-9.8 9.8L2.2 21.8"/></svg>
            Send All
          </button>
        </div>
        <div id="queueList" class="flex flex-col gap-3 h-80 overflow-y-auto pr-2"></div>
        
        <h2 class="text-xl font-semibold text-white mt-6 mb-4">Log</h2>
        <div id="log" class="bg-black rounded-lg p-3 h-40 overflow-y-auto font-mono text-sm text-gray-400"></div>
      </section>
    </main>
  </div>

  <script src="https://apis.google.com/js/api.js" async defer></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script>
  (function() {
    /* ---------- CONFIG: Replace these with your Google Cloud credentials ---------- */
    const CLIENT_ID = '1049004078268-b9bvb61inuomk357sk6dso0ra5n52rp1.apps.googleusercontent.com'; // required
    const API_KEY = 'AIzaSyApSxjHEMz5eqzJFBdjZriDdPQ8LW9aF7w'; // optional but recommended
    const SCOPES = 'https://www.googleapis.com/auth/gmail.send';

    /* ---------- DOM Elements ---------- */
    const DOMElements = {
      logEl: document.getElementById('log'),
      queueList: document.getElementById('queueList'),
      toInput: document.getElementById('toInput'),
      subjectInput: document.getElementById('subjectInput'),
      bodyInput: document.getElementById('bodyInput'),
      onlineStatus: document.getElementById('onlineStatus'),
      onlineStatusText: document.getElementById('onlineStatusText'),
      authBtn: document.getElementById('authBtn'),
      saveBtn: document.getElementById('saveBtn'),
      sendNowBtn: document.getElementById('sendNowBtn'),
      sendQueueBtn: document.getElementById('sendQueueBtn'),
      toastContainer: document.getElementById('toast-container'),
    };

    /* ---------- Local State & Constants ---------- */
    const QUEUE_KEY = 'gmail_offline_queue_v2';
    let gapiInited = false, gisInited = false, gapiLoaded = false;
    let tokenClient = null;
    let accessToken = null;
    let signedIn = false;
    let currentUserEmail = null;

    /* ---------- Toast Notifications ---------- */
    function showToast(message, type = 'info', duration = 4000) {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      DOMElements.toastContainer.appendChild(toast);
      // Trigger animation
      setTimeout(() => {
        toast.style.opacity = '1';
        toast.style.transform = 'translateY(0)';
      }, 10);
      // Auto-remove
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.addEventListener('transitionend', () => toast.remove());
      }, duration);
    }

    /* ---------- UI & Logging ---------- */
    function log(msg) {
      const t = new Date().toLocaleTimeString();
      DOMElements.logEl.innerHTML = `<div><span class="text-gray-500">[${t}]</span> ${msg}</div>` + DOMElements.logEl.innerHTML;
    }

    function renderQueue() {
      const list = loadQueue();
      const container = DOMElements.queueList;
      container.innerHTML = '';
      if (list.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 py-8">Queue is empty.</div>';
        return;
      }
      list.forEach((it, i) => {
        const el = document.createElement('div');
        el.className = 'bg-gray-800 p-3 rounded-lg border border-gray-700 item-enter';
        el.style.setProperty('--stagger-index', i);
        el.innerHTML = `
          <div class="flex justify-between items-start">
            <div>
              <div class="font-semibold text-white">${it.subject}</div>
              <div class="text-sm text-gray-400">${it.to.join(', ')}</div>
            </div>
            <button data-index="${i}" class="remove-btn text-gray-500 hover:text-red-500 transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
            </button>
          </div>
          <p class="text-sm mt-2 pt-2 border-t border-gray-700/50">${it.body.substring(0, 100)}${it.body.length > 100 ? '...' : ''}</p>
          <div class="text-xs text-gray-500 mt-2">Saved: ${new Date(it.savedAt).toLocaleString()}</div>
        `;
        container.appendChild(el);
      });
    }

    function handleRemoveClick(event) {
      const button = event.target.closest('.remove-btn');
      if (!button) return;
      
      const index = parseInt(button.dataset.index, 10);
      const itemElement = button.closest('.item-enter');
      
      if (itemElement) {
        itemElement.classList.add('item-exit');
        itemElement.addEventListener('animationend', () => {
          const q = loadQueue();
          q.splice(index, 1);
          saveQueue(q);
          log(`Removed item #${index + 1}`);
          renderQueue(); // Re-render to fix indices
        }, { once: true });
      }
    }

    /* ---------- Queue Management ---------- */
    function loadQueue() { try { return JSON.parse(localStorage.getItem(QUEUE_KEY) || '[]'); } catch(e) { return []; } }
    function saveQueue(q) { localStorage.setItem(QUEUE_KEY, JSON.stringify(q)); }
    function addToQueue(item) { const q = loadQueue(); q.push(item); saveQueue(q); log('Queued message: ' + item.subject); }

    /* ---------- RFC822 Message Encoding ---------- */
    function makeRawMessage(toList, subject, body, fromEmail) {
      const to = toList.join(', ');
      const message = [
        `From: ${fromEmail}`,
        `To: ${to}`,
        `Subject: ${subject}`,
        'MIME-Version: 1.0',
        'Content-Type: text/plain; charset="UTF-8"',
        '',
        body
      ].join('\r\n');
      return btoa(unescape(encodeURIComponent(message))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    /* ---------- Core Logic & Event Handlers ---------- */
    function updateOnlineStatus() {
      const isOnline = navigator.onLine;
      const statusText = isOnline ? 'online' : 'offline';
      DOMElements.onlineStatusText.textContent = statusText;
      DOMElements.onlineStatus.className = `status-indicator w-3 h-3 rounded-full ${statusText}`;
      DOMElements.sendNowBtn.disabled = !isOnline;
      DOMElements.sendQueueBtn.disabled = !isOnline;
    }

    function onSaveOffline() {
      const to = DOMElements.toInput.value.split(',').map(x => x.trim()).filter(Boolean);
      if (to.length === 0) { showToast('Add at least one recipient.', 'error'); return; }
      
      const item = {
        to,
        subject: DOMElements.subjectInput.value || '(no subject)',
        body: DOMElements.bodyInput.value || '',
        savedAt: Date.now(),
        status: 'queued'
      };
      addToQueue(item);
      showToast('Message saved to queue!', 'success');
      DOMElements.bodyInput.value = '';
      DOMElements.subjectInput.value = '';
      DOMElements.toInput.value = '';
      renderQueue();
    }

    async function onSendNow() {
      if (!navigator.onLine) {
        showToast('You are offline. Message queued instead.', 'info');
        onSaveOffline();
        return;
      }
      if (!signedIn) {
        showToast('Please sign in first.', 'info');
        await handleAuthClick();
        if (!signedIn) return; // Abort if auth was cancelled
      }
      
      const to = DOMElements.toInput.value.split(',').map(x => x.trim()).filter(Boolean);
      if (to.length === 0) { showToast('Add at least one recipient.', 'error'); return; }
      
      const subject = DOMElements.subjectInput.value || '(no subject)';
      const body = DOMElements.bodyInput.value || '';
      
      try {
        await sendGmailRaw(to, subject, body);
        log('Sent message (sendNow): ' + subject);
        showToast('Message sent successfully!', 'success');
        DOMElements.bodyInput.value = '';
        DOMElements.subjectInput.value = '';
      } catch (err) {
        log('Failed to send message: ' + err.message);
        showToast('Failed to send message. See log.', 'error');
      }
    }

    async function trySendQueue() {
      if (!navigator.onLine) { log('Offline: cannot send queue.'); showToast('You are offline.', 'error'); return; }
      if (!signedIn) {
        log('User not signed in — prompting auth.');
        await handleAuthClick();
        if (!signedIn) { log('Auth not granted; aborting.'); return; }
      }
      
      let q = loadQueue();
      if (q.length === 0) { log('Queue empty.'); showToast('Queue is empty.', 'info'); return; }
      
      log(`Starting to send ${q.length} queued message(s)...`);
      showToast(`Sending ${q.length} message(s)...`, 'info');
      
      let successCount = 0;
      while(q.length > 0) {
        const item = q[0]; // Always process the first item
        try {
          await sendGmailRaw(item.to, item.subject, item.body);
          log(`Sent queued: ${item.subject}`);
          q.shift(); // Remove from the front
          saveQueue(q);
          successCount++;
        } catch (err) {
          log(`Failed to send queued: ${item.subject} — ${err.message}`);
          showToast(`Failed to send "${item.subject}". Stopping queue.`, 'error');
          break; // Stop on first failure
        }
      }
      renderQueue();
      if (successCount > 0) {
        showToast(`Successfully sent ${successCount} message(s).`, 'success');
      }
    }

    /* ---------- Google API & Auth ---------- */
    async function ensureGapiLoaded() {
      if (gapiLoaded) return;
      return new Promise(resolve => {
        const interval = setInterval(() => {
          if (window.gapi && window.google) {
            clearInterval(interval);
            gapiLoaded = true;
            
            gapi.load('client', async () => {
              await gapi.client.init({ apiKey: API_KEY, discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest"] });
              gapiInited = true;
              log('gapi client initialized.');
            });

            tokenClient = google.accounts.oauth2.initTokenClient({
              client_id: CLIENT_ID,
              scope: SCOPES,
              callback: handleTokenResponse,
            });
            gisInited = true;
            resolve();
          }
        }, 100);
      });
    }
    
    function handleTokenResponse(tokenResponse) {
      if (tokenResponse.error) {
        log('Token error: ' + tokenResponse.error);
        showToast('Authentication failed.', 'error');
        signedIn = false;
        updateAuthUI();
        return;
      }
      accessToken = tokenResponse.access_token;
      gapi.client.setToken({ access_token: accessToken });
      signedIn = true;
      log('Signed in and token acquired.');
      showToast('Signed in successfully!', 'success');
      fetch('https://www.googleapis.com/oauth2/v3/userinfo', { headers: { Authorization: `Bearer ${accessToken}` } })
        .then(r => r.json()).then(j => {
          currentUserEmail = j.email;
          log('Signed in as: ' + currentUserEmail);
          updateAuthUI();
        });
    }

    function updateAuthUI() {
        const btn = DOMElements.authBtn;
        if (signedIn) {
            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg> Signed in as ${currentUserEmail.split('@')[0]}`;
            btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            btn.classList.add('bg-gray-700');
            btn.disabled = true;
        } else {
            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg> Sign In`;
        }
    }

    async function handleAuthClick() {
      await ensureGapiLoaded();
      if (gisInited) {
        tokenClient.requestAccessToken({ prompt: 'consent' });
      }
    }

    async function sendGmailRaw(toList, subject, body) {
      if (!signedIn || !accessToken) throw new Error('Not signed in.');
      if (!currentUserEmail) {
        const r = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', { headers: { Authorization: `Bearer ${accessToken}` } });
        currentUserEmail = (await r.json()).email;
      }
      const raw = makeRawMessage(toList, subject, body, currentUserEmail);
      const res = await gapi.client.gmail.users.messages.send({ userId: 'me', resource: { raw } });
      if (res.status < 200 || res.status >= 300) {
        throw new Error(`Gmail API failed: ${res.statusText || JSON.stringify(res.result)}`);
      }
      return res.result;
    }
    
    function configCheck() {
      if (CLIENT_ID.startsWith('YOUR_CLIENT_ID')) {
        log('Configuration needed: Please set your CLIENT_ID in the script.');
        showToast('Configuration needed for Google Sign-In.', 'error', 10000);
        DOMElements.authBtn.disabled = true;
        DOMElements.sendNowBtn.disabled = true;
        DOMElements.sendQueueBtn.disabled = true;
      }
    }

    /* ---------- Initialization ---------- */
    window.addEventListener('load', () => {
      renderQueue();
      updateOnlineStatus();
      configCheck();
      
      window.addEventListener('online', () => { log('Browser is online.'); updateOnlineStatus(); trySendQueue(); });
      window.addEventListener('offline', () => { log('Browser is offline.'); updateOnlineStatus(); });

      DOMElements.saveBtn.addEventListener('click', onSaveOffline);
      DOMElements.sendNowBtn.addEventListener('click', onSendNow);
      DOMElements.sendQueueBtn.addEventListener('click', trySendQueue);
      DOMElements.authBtn.addEventListener('click', handleAuthClick);
      DOMElements.queueList.addEventListener('click', handleRemoveClick);
      
      ensureGapiLoaded();
    });
  })();
  </script>
</body>
</html>
